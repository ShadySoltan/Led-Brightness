#include "tm4c123gh6pm.h"

void PORTF_INIT()
{
    // Turn on Clock
    SYSCTL_RCGCGPIO_R = 0x20;
    while ((SYSCTL_PRGPIO_R & 0x20) == 0);
}

void PORTF_LEDs_INIT(void) //Initialize lEDs as GPIO
{
    // Configure the Board LEDs
    PORTF_INIT();
    // Turn off Alternate Function
    GPIO_PORTF_AFSEL_R &= 0xF1;
    // Turn off Analog Mode
    GPIO_PORTF_AMSEL_R &= 0xF1;
    // Configure all three pins as output
    GPIO_PORTF_DIR_R |= 0x0E;
    // Choose GPIO mode for the three pins
    GPIO_PORTF_PCTL_R &= 0xFFFF000F;
    // Enable pins
    GPIO_PORTF_DEN_R |= 0x0E;
    // Turn off pins
    GPIO_PORTF_DATA_R &= 0xF1;
}

void PORTF_LEDs_INIT_PWMmode(void) //Initialize lEDs pins as PWM
{
    // Initialize Port F
    PORTF_INIT();

    // Enable Alternate Function for PF1, PF2, PF3 (for PWM)
    GPIO_PORTF_AFSEL_R |= 0x0E;

    // Disable Analog Mode on PF1, PF2, PF3
    GPIO_PORTF_AMSEL_R &= ~0x0E;

    // Set PF1, PF2, PF3 as Outputs
    GPIO_PORTF_DIR_R |= 0x0E;

    // Configure PF1, PF2, PF3 for PWM
    GPIO_PORTF_PCTL_R &= 0xFFFF000F;  // Clear PF1, PF2, PF3 fields
    GPIO_PORTF_PCTL_R |= 0x00005550;  // Set PF1, PF2, PF3 for M1PWM5, M1PWM6, M1PWM7

    // Enable Digital Functionality on PF1, PF2, PF3
    GPIO_PORTF_DEN_R |= 0x0E;

    // Turn off LEDs (initially)
    GPIO_PORTF_DATA_R &= ~0x0E;
}

void PWM_M1_INIT(void)
{
    // Step 1: Enable Clock for PWM Module 1
    SYSCTL_RCGCPWM_R |= 0x02;      // Enable clock to PWM Module 1 (M1)

    // Step 2: Enable Clock for Port F
    SYSCTL_RCGCGPIO_R |= 0x20;     // Enable clock to Port F

    // Step 3: Wait until Port F is ready
    while ((SYSCTL_PRGPIO_R & 0x20) == 0);

    // Step 4: Set PF1, PF2, and PF3 to be controlled by PWM (configure alternate function)
    GPIO_PORTF_AFSEL_R |= 0x0E;    // Enable alternate functions on PF1 (Red), PF2 (Blue), PF3 (Green)
    GPIO_PORTF_PCTL_R &= ~0x000FFF0;  // Clear the PCTL bits for PF1, PF2, PF3
    GPIO_PORTF_PCTL_R |= 0x0005550;   // Set PCTL bits for PWM function

    // Step 5: Disable analog functionality on PF1, PF2, PF3
    GPIO_PORTF_AMSEL_R &= ~0x0E;   // Disable analog mode on PF1, PF2, PF3

    // Step 6: Set PF1, PF2, PF3 as digital pins
    GPIO_PORTF_DEN_R |= 0x0E;      // Enable digital function on PF1, PF2, PF3

    // Step 7: Disable PWM generators during setup
    PWM1_2_CTL_R = 0;   // Disable PWM Generator 2 (controls M1PWM5 on PF1)
    PWM1_3_CTL_R = 0;   // Disable PWM Generator 3 (controls M1PWM6 on PF2 and M1PWM7 on PF3)

    // Step 8: Configure the PWM generators
    PWM1_2_GENA_R = PWM_2_GENA_ACTCMPAD_ONE | PWM_2_GENA_ACTLOAD_ZERO;  // Set M1PWM5 (PF1)
    PWM1_3_GENA_R = PWM_3_GENA_ACTCMPAD_ONE | PWM_3_GENA_ACTLOAD_ZERO;  // Set M1PWM6 (PF2)
    PWM1_3_GENB_R = PWM_3_GENB_ACTCMPBD_ONE | PWM_3_GENB_ACTLOAD_ZERO;  // Set M1PWM7 (PF3)

    // Step 9: Set the Load value for a 1 kHz PWM signal
    PWM1_2_LOAD_R = 16000 - 1;  // Assuming a 16 MHz system clock
    PWM1_3_LOAD_R = 16000 - 1;

    // Step 10: Set the compare value for 100% duty cycle
    PWM1_2_CMPA_R = 0;  // 100% duty cycle for M1PWM5 (PF1 - Red LED)
    PWM1_3_CMPA_R = 0;  // 100% duty cycle for M1PWM6 (PF2 - Blue LED)
    PWM1_3_CMPB_R = 0;  // 100% duty cycle for M1PWM7 (PF3 - Green LED)

    // Step 11: Enable PWM generators
    PWM1_2_CTL_R |= PWM_2_CTL_ENABLE;  // Enable PWM Generator 2
    PWM1_3_CTL_R |= PWM_3_CTL_ENABLE;  // Enable PWM Generator 3

    // Step 12: Enable PWM outputs on PF1, PF2, PF3
    PWM1_ENABLE_R |= PWM_ENABLE_PWM5EN | PWM_ENABLE_PWM6EN | PWM_ENABLE_PWM7EN;

    // The PWM signals should now be active on PF1, PF2, PF3
}

void main(void)
{
    PORTF_INIT();               // Initialize Port F
    PORTF_LEDs_Init_PWMmode();  // Configure PF1, PF2, PF3 for PWM mode
    PWM_M1_INIT();              // Initialize PWM Module 1 for LEDs

    while (1)
    {
        // Infinite loop; Blue LED should be on with PWM (100% duty cycle)
    }
}
